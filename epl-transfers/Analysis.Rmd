---
title: "Wise investments in the EPL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Who is getting their money's worth in the English Premier League?

In my last post, I presented a few plots around some data I put together around the EPL's transfer market. In this post, I tie the transfer market into the actual season results to see the effect of transfers. Unlike my last post, this one will be a little more involved, with code to boot.

All data can be found in my [epl-transfers repo](https://github.com/delafields/data-projects/tree/master/epl-transfers).

## Transfer Trends
I first did some exploration around what the overall trend in terms of £'s spent looked like, just to get a feel for the data and formulate some ideas for analysis.

![](C:/Users/jfields/Desktop/Code/data-projects/epl-transfers/plots/total_spend_YoY.png)

In order to analyze the current market, it would be wise to set a cutoff date for it. From the chart above we can clearly see an upward trend starting in 2011, right after a steady crash in 2008 ([wonder why](https://en.wikipedia.org/wiki/Stock_market_crash#Crash_of_2008%E2%80%932009)). 

Note that this also gives us the added benefit of not having to do a lot of work around promotion/relegation. 3 teams get sent up to the EPL from the Championship and vise versa every year, so we won't get as clean of reads for the clubs that bounce up and down often.

## Data Processing

**Skip to the next section if you aren't interested**

First thing's first, we bring season end results tables scraped from Wikipedia and use this to create a dataframe of transfers per year per team.
```{r}

library(dplyr)
library(stringr)

####### Import data #######

# handy function to merge csvs together
# (via https://stackoverflow.com/questions/30242065/trying-to-merge-multiple-csv-files-in-r/30242347)
multmerge = function(path){
    filenames = list.files(path=path, full.names=TRUE)
    
    datalist = lapply(filenames, function(x){
        read.csv(file = x, header = T)})
    
    Reduce(function(x, y) {merge(x, y, all = TRUE)}, datalist)
}

transfer_data <- multmerge("data/transfer-data")
results_data  <- multmerge("data/epl-results")
inflation <- read.csv(file = "data/Inflation_Adjustment.csv", fileEncoding="UTF-8-BOM")

####### Data Processing #######

transfer_data <- rename(transfer_data, Team = club_name)  # rename `club_name` to `Team` to match results
transfer_data[is.na(transfer_data)] <- 0                  # replace na's

grouped_transfer_data <- transfer_data %>%
  left_join(inflation, by = "year") %>%
  mutate(corrected_fee = ifelse(transfer_movement == "out", fee_cleaned * -1, fee_cleaned),  # negate "out" transfers
         adj_fee = corrected_fee * (1 + .01 * inflation$Inflation),                          # adjust for inflation
         Team = str_replace_all(Team, " FC", ""),                                            # match results table names
         Team = str_replace_all(Team, "AFC", ""),                                            # match results table names
         Team = trimws(Team)) %>%
  group_by(Team, year) %>%
  summarise(total_spend = sum(adj_fee))


results_data <- results_data %>% 
  rename(QualRel = Qualification.or.relegation) %>%
  mutate(Team = str_replace_all(Team, " \\(\\S\\)", ""),  # remove the (C)'s and (R)'s from Team names
         year = substr(year, start = 1, stop = 4),        # trim year to just the first yyyy
         year = as.numeric(year),
         QualRel = case_when(str_detect(QualRel, "Champions League") == TRUE ~ "CL",        # bucket into qualification/relegation
                             str_detect(QualRel, "Europa League")    == TRUE ~ "EL",
                             str_detect(QualRel, "Relegation")       == TRUE ~ "Relegated",
                             TRUE ~ "Midtable"))

    
# join transfers to results
epl_data <- results_data %>% 
    right_join(grouped_transfer_data, by = c("Team", "year")) %>%
    arrange(year) %>%
    filter(year >= 2011) # our cutoff

head(epl_data)
```

### Feature Engineering

To be able to see how teams results changed as an effect of their spend, we'll create a few new features: WinChange, LossChange, GFChange, GAChange, and PtsChange.

And ultimately, because we're concered about the effects of spend, a few more features. We'll divide all of our `{}Change` features by `total_spend` features to get to see things like number of wins gained per million spent.

```{r message=FALSE}

# convert year back to date to calculate lag and convert Pts to numeric
epl_data <- epl_data %>% mutate(year = as.Date(ISOdate(year, 1, 1)), Pts = as.numeric(Pts))

# calc YoY points change
epl_data <- epl_data %>% group_by(Team) %>%
    arrange(year) %>%
    mutate(WinChange  = W   - lag(W, 1),
           LossChange = L   - lag(L, 1),
           PtsChange  = Pts - lag(Pts, 1),
           GFChange   = GF  - lag(GF, 1),
           GAChange   = GA  - lag(GA, 1)) %>%
    mutate(MillPerWinGained  = total_spend / WinChange,
           MillPerLossGained = total_spend / LossChange,
           MillPerPtsGained  = total_spend / PtsChange,
           MillPerGFGained   = total_spend / GFChange,
           MillPerGAGained   = total_spend / GAChange) %>%
    na.omit() # removes 2011 data and pro/rel teams

# replace inf's
epl_data[epl_data == -Inf | epl_data == Inf] <- 0

# remove later
arsenal <- epl_data %>% filter(Team == 'Arsenal')

head(epl_data %>% select(year, total_spend, PtsChange, MillPerPtsGained))
```

## So, who got their money's worth?

```{r fig.height = 5, fig.width = 12, fig.align = "center"}
library(ggplot2)
library(ggrepel)

per_team <- epl_data %>%
    group_by(Team) %>%
    summarise(avg_spend               = mean(total_spend),
              total_spend             = sum(total_spend),
              avg_pts                 = mean(Pts),
              avg_pts_change          = mean(PtsChange),
              avg_mill_per_pts_gained = mean(MillPerPtsGained))

historical_pts_average <- results_data %>% 
    mutate(Pts = str_replace_all(Pts, "19[c]", "")) %>%  # one weird data point
    mutate(Pts = as.numeric(Pts)) %>%
    summarise(mean_pts = mean(Pts, na.rm = TRUE)) %>%
    pull()  

ggplot(per_team, aes(x = avg_spend, y = avg_pts)) +
  geom_point(shape = 21, colour = "#38003c", fill = "#00ff85", size = 4, stroke = 2) +
  geom_hline(yintercept = as.double(historical_pts_average), color="#e90052", linetype="dashed") +
  geom_text_repel(aes(label = Team), data = subset(per_team, avg_pts > as.double(historical_pts_average)),
                   point.padding = 0.5, segment.color = "grey50", family = "poppins") +
  labs(y = "Average Points", x = "Average Spend (Millions £)") +
    theme(text = element_text(family = "poppins"),
          plot.title = element_text(face = "bold", color = "#38003c", size = 8),
          plot.subtitle = element_text(size = 5),
          axis.title = element_text(face = "bold", size = 10),
          axis.line.x = element_line(),
          axis.text = element_text(size = 8),
          axis.ticks = element_blank(),
          panel.grid.major = element_line(colour = "#e0e0e0", linetype = "dashed", size=0.1),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(), 
          panel.background = element_blank())

```

The Big 6 are represented well here! That's Arsenal, Liverpool, Chelsea, Manchester United, Manchester City, and Tottenham. The horizontal line is the historical points average, so everyone above that is performing above average. Some standout points here:

* City is spending the most but reaping the results in terms of points.
* United also spends a ton but haven't separated themselves points-wise from the rest of the Big 6
* Tottenham has done the most with the least amount of spend - they actually average a profit in the transfer market (< 0)


Premier League teams have goals outside of winning the league itself. They also look to qualify for the Champions League (by ranking 1-4), qualify for Europa League (by ranking 5-6), or avoid relegation (ranking 18-20). Let's look at the effect of spend on these qualifications:

```{r fig.height = 5, fig.width = 15, fig.align = "center"}

average_QualRel <- epl_data %>% group_by(QualRel) %>% summarise(total_spend = mean(total_spend))

ggplot(epl_data, aes(x = total_spend, y = QualRel, size = 3)) + 
  geom_point(shape = 21, colour = "#38003c", fill = "#00ff85", size = 4, stroke = 2) + 
  geom_point(data = average_QualRel, color = "red", shape = "diamond", alpha = 0.75) +
  labs(x = "Total Spend (Millions £)", y = "", size="Average Spend") +
  theme(text = element_text(family = "poppins"),
        plot.title = element_text(face = "bold", color = "#38003c", size = 8),
        plot.subtitle = element_text(size = 5),
        axis.title = element_text(face = "bold", size = 8),
        axis.line.x = element_line(),
        axis.text = element_text(size = 8),
        axis.ticks = element_blank(),
        panel.grid.major = element_line(colour = "#e0e0e0", linetype = "dashed", size=0.1),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(),
        legend.text = element_blank(),
        legend.position = c(0.75, 0.75))

```

It's fascinating to see that relegated teams, on average, spend more than midtable and europa league squads.


Outside of these raw, overall trends, I'm really interested to see what specific transfer windows had the biggest effect on the next season. We can look at the `MillPerPtsGained` feature we created to see how many $'s were spent for a gain in points.


```{r fig.height = 7, fig.width = 7, fig.align = "center"}


ggplot(epl_data, aes(y = MillPerPtsGained, x = PtsChange)) +
  geom_point(shape = 21, colour = "#38003c", fill = "#00ff85", size = 4, stroke = 2) +
  geom_text_repel(aes(label = ifelse(abs(MillPerPtsGained) > 25, as.character(Team),'')), 
                  family = "poppins", direction = "y", xlim = c(20, NA), segment.color = "grey50") +
  labs(y = "Million £ Spent Per Point Change", x = "Points Change From Last Season") +
  theme(text = element_text(family = "poppins"),
        plot.title = element_text(face = "bold", color = "#38003c", size = 8),
        plot.subtitle = element_text(size = 5),
        axis.title = element_text(face = "bold", size = 8),
        axis.line.x = element_line(),
        axis.text = element_text(size = 8),
        axis.ticks = element_blank(),
        panel.grid.major = element_line(colour = "#e0e0e0", linetype = "dashed", size=0.1),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank())

```



Change in points is the most important feature here, in my opinion. It is predicated upon Wins, Losses, and Draws - Goals For and Goals Against play into those as well. And...it determines the league winner, european league competitions, and relegation.

Let's look at who has spent the MOST for small point swings. This isn't necessarily a bad thing if it's in the red. You can only top out at so many points and you might just be spending to maintain your position in the table.


```{r fig.height = 7, fig.width = 7, fig.align = "center"}


ggplot(epl_data, aes(y = total_spend, x = PtsChange)) +
  geom_point(shape = 21, colour = "#38003c", fill = "#00ff85", size = 4, stroke = 2) +
  geom_text_repel(aes(label = ifelse(PtsChange > 20, 
                                     as.character(paste(Team, " ", PtsChange, " pts\n for £", round(total_spend), "M", sep = "")),'')), 
                  family = "poppins", direction = "y", segment.color = "grey50", point.padding = 0.5) +
  labs(y = "Total Spend Million £", x = "Points Change From Last Season") +
  theme(text = element_text(family = "poppins"),
        plot.title = element_text(face = "bold", color = "#38003c", size = 8),
        plot.subtitle = element_text(size = 5),
        axis.title = element_text(face = "bold", size = 8),
        axis.line.x = element_line(),
        axis.text = element_text(size = 8),
        axis.ticks = element_blank(),
        panel.grid.major = element_line(colour = "#e0e0e0", linetype = "dashed", size=0.1),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank())

```

How about we average some of these figures to get an idea of how clubs do on an overall basis?

```{r fig.height = 7, fig.width = 7, fig.align = "center"}
ggplot(epl_data, aes(y = total_spend, x = PtsChange)) +
  geom_point(shape = 21, colour = "#38003c", fill = "#00ff85", size = 4, stroke = 2) +
  geom_text_repel(aes(label = ifelse(PtsChange < -20, 
                                     as.character(paste(Team, " ", PtsChange, " pts\n for £", round(total_spend), "M", sep = "")),'')), 
                  family = "poppins", direction = "y", segment.color = "grey50", nudge_x = -20) +
  labs(y = "Total Spend Million £", x = "Points Change From Last Season") +
  xlim(-75, NA) +
  theme(text = element_text(family = "poppins"),
        plot.title = element_text(face = "bold", color = "#38003c", size = 8),
        plot.subtitle = element_text(size = 5),
        axis.title = element_text(face = "bold", size = 8),
        axis.line.x = element_line(),
        axis.text = element_text(size = 8),
        axis.ticks = element_blank(),
        panel.grid.major = element_line(colour = "#e0e0e0", linetype = "dashed", size=0.1),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank())
```

NEXT - AVERAGE SPEND PER AVERAGE POINTS

```{r fig.height = 7, fig.width = 7, fig.align = "center"}

ggplot(data=per_team, aes(x = reorder(Team, avg_mill_per_pts_gained), y = avg_mill_per_pts_gained, label = avg_mill_per_pts_gained)) + 
    geom_bar(stat="identity", fill = ifelse(per_team$avg_mill_per_pts_gained > 0, "#00ff85", "red"), color="#38003c", size = 1) + 
    coord_flip() + 
    labs(y = "Average Million £ Per Point Change") +
    geom_text(data =  per_team[abs(per_team$avg_mill_per_pts_gained) > 3,],
              aes(label = round(avg_mill_per_pts_gained, 2)), position = position_stack(vjust = 0.5), family = "poppins") +
    theme(text = element_text(family = "poppins"),
          plot.title = element_text(face = "bold", color = "#38003c", size = 8),
          plot.subtitle = element_text(size = 5),
          axis.text = element_text(size = 5),
          axis.title.y = element_blank(),
          axis.ticks = element_blank(),
          panel.background = element_rect(fill = 'white'),
          panel.grid.major = element_line(colour = "#e0e0e0", linetype = "dashed", size=0.1),
          panel.grid.major.y = element_blank(),
          panel.grid.minor = element_blank())
```